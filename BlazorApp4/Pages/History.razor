@page "/TransactionHistory"
@inject IAccountService AccountService
@inject AppState AppState
@inject NavigationManager Navigation

<!-- Transaction history -->
<h3 class="mb-3">Transaction History</h3>

@if (_accounts.Count == 0)
{
    <p>No accounts excists.</p>
}
else
{
    <!-- Account selection -->
    <div class="mb-2">
        <label>Choose Account</label>
        <InputSelect TValue="Guid"
                     class="form-select"
                     id="accountSelect"
                     @bind-Value="SelectedAccountId">
            @foreach (var account in _accounts)
            {
                <option value="@account.Id">@account.Name - Balance: @account.Balance</option>
            }
        </InputSelect>
    </div>

    <!-- Filter -->
    <div class="mb-3">
        <div class="row g-3">
            <div class="col-md-3">
                <label>From date</label>
                <InputDate @bind-Value="fromDate" class="form-control" />
            </div>
            <div class="col-md-3">
                <label>To date</label>
                <InputDate @bind-Value="toDate" class="form-control" />
            </div>
            <div class="col-md-3">
                <label>Min amount</label>
                <InputNumber @bind-Value="minAmount" class="form-control" />
            </div>
            <div class="col-md-3">
                <label>Max amount</label>
                <InputNumber @bind-Value="maxAmount" class="form-control" />
            </div>
            <div class="col-md-3">
                <label>Transaction type</label>
                <InputSelect @bind-Value="selectedType" class="form-select">
                    <option value="">All types</option>
                    @foreach (var type in Enum.GetValues<TransactionType>())
                    {
                        <option value="@type">@type</option>
                    }
                </InputSelect>
            </div>
        </div>
    </div>

    <button class="btn btn-secondary mt-2" @onclick="ClearFilters">Clear filters</button>


    <!-- Sortbutton (date/amount) -->
    <div class="mb-2">
        <button class="btn btn-sm" @onclick="() => SetSort(SortKey.Date)">
            ↓↑ Date @(currentKey == SortKey.Date ? (descending ? "↓" : "↑") : "")
        </button>
        <button class="btn btn-sm" @onclick="() => SetSort(SortKey.Amount)">
            ↓↑ Amount @(currentKey == SortKey.Amount ? (descending ? "↓" : "↑") : "")
        </button>
    </div>
}

@if (_selectedAccount == null)
{
    <p> Choose Account a account to view transactions </p>
}
else
{
    <!-- Transaction table -->
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Transaction Type</th>
                <th>Amount after transaction</th>
                <th>from -> to</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var transaction in sortedTransaction())
            {
                <tr>
                    <td>@transaction.TimeStamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                    <td>@transaction.Amount</td>
                    <td>@transaction.transactionType</td>
                    <td>@transaction.BalanceAfterTransaction</td>
                    <td>
                        @if (transaction.FromAccountId.HasValue || transaction.ToAccountId.HasValue)
                        {
                            <span>@(transaction.FromAccountId.ToString()[..6]) -> @(transaction.ToAccountId.ToString()[..6])</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Export import buttons -->
    @if (_selectedAccount != null)
    {
        <button class="btn btn-primary mt-3" @onclick="ExportTransactions">
            Export Transactions to JSON
        </button>
        <button class="btn btn-secondary mt-3" @onclick="ImportTransactions">
            Import Transactions from JSON
        </button>
    }
}

<!-- Code for design -->
@code {
    /// List and fields
    private List<BankAccount> _accounts = new();
    private BankAccount? _selectedAccount;
    private Guid _selectedAccountId;
    private SortKey currentKey = SortKey.Date;
    private bool descending = true;

    // Filter variables
    private DateTime? fromDate;
    private DateTime? toDate;
    private decimal? minAmount;
    private decimal? maxAmount;
    private string? selectedType;

    /// <summary>
    /// Sorting options for transaction list
    /// </summary>
    private enum SortKey
    {
        Date,
        Amount
    }

    /// <summary>
    /// Toggles sorting key and direction on user click on button
    /// </summary>
    /// <param name="sortKey">Sorting options</param>
    private void SetSort(SortKey sortKey)
    {
        if (currentKey == sortKey)
        {
            descending = !descending;
        }
        else
        {
            currentKey = sortKey;
            descending = true;
        }
    }

    /// <summary>
    /// Clears all active filters and resets view
    /// </summary>
    private void ClearFilters()
    {
        fromDate = null;
        toDate = null;
        minAmount = null;
        maxAmount = null;
        selectedType = null;
    }

    /// <summary>
    /// Property for binding the selected accounts ID in the dropdown
    /// Updates the selected account and triggers UI refresh
    /// </summary>
    private Guid SelectedAccountId
    {
        get => _selectedAccountId;
        set
        {
            if (_selectedAccountId == value)
                return;
            _selectedAccountId = value;
            _selectedAccount = _accounts.FirstOrDefault(account => account.Id == value);
            StateHasChanged();
        }
    }

    /// <summary>
    /// Loads all accounts on component initialized and selects the first by default
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        if (!AppState.IsLoggedIn)
        {
            Navigation.NavigateTo("/home", replace: true);
            return;
        }
        await AccountService.EnsureLoadedAsync();
        _accounts = AccountService.GetAccounts();

        // If there is accounts in our lust, chose first to show in UI
        if (_accounts.Count > 0)
        {
            _selectedAccountId = _accounts[0].Id;
            _selectedAccount = _accounts[0];
        }
        StateHasChanged();
        AccountService.StateChanged += OnStateChanged;
        AccountService.AutoApplyDailyInterest();
    }

    public void OnStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Returns a filtered and sorted list of transactions for the selected account
    /// </summary>
    /// <returns>Sorted and or orderd Enumerable</returns>
    private IEnumerable<Transaction> sortedTransaction()
    {
        if (_selectedAccount == null)
            return Enumerable.Empty<Transaction>();

        // Sorts enummerable on date and amount
        var filteredList = _selectedAccount.Transactions.AsEnumerable();
        if (fromDate.HasValue)
            filteredList = filteredList.Where(t => t.TimeStamp.Date >= fromDate.Value.Date);
        if (toDate.HasValue)
            filteredList = filteredList.Where(t => t.TimeStamp.Date <= toDate.Value.Date);

        // Filter amount intervall
        if (minAmount.HasValue)
            filteredList = filteredList.Where(t => t.Amount >= minAmount.Value);
        if (maxAmount.HasValue)
            filteredList = filteredList.Where(t => t.Amount <= maxAmount.Value);

        // Filter Transaction type
        if (!string.IsNullOrEmpty(selectedType) &&
            Enum.TryParse<TransactionType>(selectedType, out var parsedType))
        {
            filteredList = filteredList.Where(t => t.transactionType == parsedType);
        }

        filteredList = currentKey switch
        {
            SortKey.Amount => (descending
            ? filteredList.OrderByDescending(transaction => transaction.Amount)
            : filteredList.OrderBy(transaction => transaction.Amount)),
            SortKey.Date => (descending
                ? filteredList.OrderByDescending(transaction => transaction.TimeStamp)
                : filteredList.OrderBy(transaction => transaction.TimeStamp))
        };
        return filteredList;
    }

    /// <summary>
    /// Exports all transactions of the selected account to a JSON file
    /// </summary>
    private async Task ExportTransactions()
    {
        if (_selectedAccount != null)
        {
            Console.WriteLine($"[TransactionHistory] Exporting {_selectedAccount.Name}");
            await AccountService.ExportTransactionsAsync(_selectedAccount.Id);
        }
    }

    /// <summary>
    /// Imports transactions from a JSON file and refreshes the account list
    /// </summary>
    private async Task ImportTransactions()
    {
        Console.WriteLine("[TransactionHistory] Importing JSON");
        await AccountService.ImportTransactionAsync();

        await AccountService.EnsureLoadedAsync();
        _accounts = AccountService.GetAccounts();
        StateHasChanged();
    }


}