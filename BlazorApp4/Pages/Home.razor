@page "/home"
@layout NoNavLayout
@inject IAccountService AccountService
@inject NavigationManager Navigation
@inject AppState AppState

<!-- Home page/login page -->
<h3>Welcome to my bank app!</h3>
<br/>

<!-- Login field -->
<div class="form-group" id="codeInputContainer" style="max-width: 200px;">
    <label for="inputCode" class="form-label">Input pin code to log in:</label>
    <InputText id="inputCode"
               class="form-control"
               @bind-Value="userCode"
               type="password"
               inputmode="numeric"
               pattern="[0-9]*"
               @oninput="OnlyDigits" />
</div>

<!-- Login button -->
@if (!string.IsNullOrEmpty(userCode) && IsDigitsOnly(userCode))
{
    <button class="btn btn-primary mt-2" @onclick="HandleLogin">Login</button>
}

<!-- Error message -->
@if (!string.IsNullOrEmpty(message))
{
    <div class="text-danger mt-2">@message</div>
}

@code {
    //private fields
    private string userCode = string.Empty;
    private string message = string.Empty;

    /// <summary>
    /// Ensures that only digits are entered into the PIN field
    /// </summary>
    private void OnlyDigits(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        var sb = new System.Text.StringBuilder(value.Length);
        foreach (var ch in value)
        {
            if (char.IsDigit(ch)) sb.Append(ch);
        }

        userCode = sb.ToString();
        Console.WriteLine($"[Home] PIN input updated: {userCode.Length} digits entered.");
    }

    /// <summary>
    /// Validates that the given string contains only digits.
    /// </summary>
    private bool IsDigitsOnly(string str)
    {
        if (string.IsNullOrEmpty(str)) return false;
        foreach (var ch in str)
        {
            if (!char.IsDigit(ch)) return false;
        }
        return true;
    }

    /// <summary>
    /// Handles user login by validating the entered PIN code.
    /// Redirects to the Create Account page if login succeeds.
    /// </summary>
    private async Task HandleLogin()
    {
        message = string.Empty;
        Console.WriteLine($"[Home] Attempting login with PIN length: {userCode.Length}");
        var ok = await AccountService.ValidatePinAsync(userCode);
        if (ok)
        {
            Console.WriteLine("[Home] Login successful. Redirecting to CreateAccount page");
            AppState.SetLoggedIn(true);
            Navigation.NavigateTo("/CreateAccount", forceLoad: false, replace: true);
        }
        else
        {
            Console.WriteLine("[Home] Login failed: Invalid PIN entered.");
            message = "Wrong code, try again.";
            userCode = string.Empty;
        }
    }

}